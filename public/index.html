<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Territory Masters â€” ç”Ÿå­˜ãƒ«ãƒ¼ãƒ« / 1ã€œ2ãƒã‚¹ç§»å‹• / é£›ã³è¶Šãˆä¸å¯ / çµ‚å±€ï¼æœ€å¾Œã®1äºº</title>

<!-- Socket.IOï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³åŒæœŸï¼‰ -->
<script src="/socket.io/socket.io.js"></script>

<style>
  :root{ --bg:#0f1226; --panel:#121730; --text:#e5e7eb; --muted:#94a3b8; --grid:#1e2447; --ok:#10b981; --warn:#ef4444;
         --pA:#60a5fa; --pB:#f59e0b; --pC:#34d399; --pD:#f472b6; --pE:#f87171; --pF:#a78bfa }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:
    radial-gradient(1200px 800px at 10% -10%, rgba(99,102,241,.25), transparent 60%),
    radial-gradient(1200px 800px at 110% 0%, rgba(56,189,248,.15), transparent 60%), var(--bg); color:var(--text);
    display:flex; flex-direction:column; gap:12px; padding:16px; padding-bottom:24px}
  header{display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap}
  h1{margin:0; font-size:20px}
  .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  button, select, input{background:linear-gradient(180deg,#243065,#1a224f); border:1px solid rgba(255,255,255,.08); color:var(--text); padding:10px 12px; border-radius:12px; font-weight:700}
  button{cursor:pointer}
  button:hover{filter:brightness(1.06)}
  main{display:grid; grid-template-columns: 1fr 380px; gap:12px}
  @media (max-width:980px){ main{grid-template-columns: 1fr} }
  .boardWrap{position:relative; background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px; display:flex; justify-content:center; align-items:center}
  svg{width:min(96vw,860px); height:auto; aspect-ratio:1/1; touch-action:manipulation}
  .hex{stroke:#0b102a; stroke-width:1.2; fill:#18304a; transition:filter .15s}
  .hex.dark{fill:#14263d}
  .hex.hole{fill:#0b1030}
  .hex.legal{stroke-dasharray:4 3; stroke:#9ca3af}
  .hex.path{stroke:#6ee7b7}
  .disc{pointer-events:none}
  .A{fill:var(--pA)} .B{fill:var(--pB)} .C{fill:var(--pC)} .D{fill:var(--pD)} .E{fill:var(--pE)} .F{fill:var(--pF)}
  .sel{stroke:#fcd34d; stroke-width:3}
  .side{background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:10px}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .stat{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:8px 10px; font-weight:700}
  .muted{color:var(--muted)}
  .log{min-height:140px; max-height:40vh; overflow:auto; background:#0b1030; border:1px solid rgba(255,255,255,.1); border-radius:12px; padding:10px; font-family:ui-monospace, Menlo, Consolas, monospace; font-size:13px}
  .players{display:flex; gap:8px; flex-wrap:wrap}
  .chip{display:inline-flex; gap:6px; align-items:center; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:999px; padding:6px 10px; font-weight:700}
  .dot{width:12px; height:12px; border-radius:50%}
  @media (max-width:720px){ h1{font-size:18px} button, select{padding:12px 14px; border-radius:14px} .stat{padding:10px 12px} .log{max-height:30vh}}
</style>
</head>
<body>
  <header>
    <h1>Territory Mastersï¼ˆ<span class="muted"> ç”Ÿå­˜ãƒ«ãƒ¼ãƒ« / 1ã€œ2ãƒã‚¹ç§»å‹• / é£›ã³è¶Šãˆä¸å¯</span>ï¼‰</h1>
    <div class="controls">
      <button id="newBtn" aria-label="ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ ">ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ </button>
      <button id="regenBtn" aria-label="åœ°å½¢å†ç”Ÿæˆ">åœ°å½¢å†ç”Ÿæˆ</button>
      <label class="stat">äººæ•°
        <select id="playersSel" aria-label="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°">
          <option value="2">2äºº</option>
          <option value="3" selected>3äºº</option>
          <option value="4">4äºº</option>
          <option value="5">5äºº</option>
        </select>
      </label>
      <label class="stat">ç›¤ã‚µã‚¤ã‚ºï¼ˆåŠå¾„ï¼‰
        <select id="radiusSel" aria-label="ç›¤ã®åŠå¾„">
          <option value="4">å° (R=4)</option>
          <option value="5" selected>ä¸­ (R=5)</option>
          <option value="6">å¤§ (R=6)</option>
        </select>
      </label>
      <label class="stat">ç©´% <span id="holePerc">10</span>
        <input id="holeRange" type="range" min="0" max="30" step="1" value="10" aria-label="ç©´ã®å‰²åˆ" />
      </label>
      <span class="stat">æ‰‹ç•ª: <span id="turn">A</span></span>
    </div>

    <!-- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å…¥å®¤UI -->
    <div class="controls">
      <input id="roomInput" placeholder="ãƒ«ãƒ¼ãƒ IDï¼ˆä¾‹: abc123ï¼‰" style="padding:10px;border-radius:10px;border:1px solid #fff2" />
      <button id="joinBtn" aria-label="å…¥å®¤">å…¥å®¤</button>
      <span id="roleView" class="muted"></span>
    </div>
  </header>

  <main>
    <div class="boardWrap">
      <svg id="svg" viewBox="0 0 1000 1000" role="img" aria-label="hex board"></svg>
    </div>

    <aside class="side">
      <div class="players" id="playersPanel"></div>
      <div class="row">
        <div class="stat" style="line-height:1.5">
          ãƒ«ãƒ¼ãƒ«è¦ç´„ï¼š<br>
          ãƒ»åˆæ‰‹ã¯ç›¤ä¸Šã®ã©ã“ã§ã‚‚OKï¼ˆç©´ãƒ»å æœ‰ä»¥å¤–ï¼‰<br>
          ãƒ»æ‰‹ç•ªã§ã¯è‡ªã‚³ãƒã‚’<b>1ãƒã‚¹ or 2ãƒã‚¹</b>ã®ç›´ç·šç§»å‹•ï¼ˆ2ãƒã‚¹æ™‚ã¯<b>ä¸­ç¶™ãƒã‚¹ã‚‚ç©ºãå¿…é ˆ</b>ï¼<b>æ•µã®é£›ã³è¶Šãˆä¸å¯</b>ï¼‰<br>
          ãƒ»ç§»å‹•å¾Œã€<b>ç§»å‹•å‰ã®ãƒã‚¹ã¯æ¶ˆãˆã‚‹ï¼ˆç©´åŒ–ï¼‰</b><br>
          ãƒ»<b>å‹•ã‘ãªããªã£ãŸã‚‰å³è„±è½</b>ï¼ˆä»¥å¾Œ æ‰‹ç•ªã¯å›ã£ã¦ã“ãªã„ï¼‰<br>
          ãƒ»<b>æœ€å¾Œã®1äººã«ãªã£ãŸæ™‚ç‚¹ã§ã‚²ãƒ¼ãƒ çµ‚äº†</b>ï¼ˆç”Ÿå­˜é †ï¼é †ä½ï¼‰
        </div>
      </div>
      <div class="row">
        <button id="undoBtn">ã‚¢ãƒ³ãƒ‰ã‚¥</button>
      </div>
      <div class="log" id="log"></div>
      <div class="muted">æ³¨: ãƒ©ãƒ³ãƒ€ãƒ å…­è§’ç›¤ï¼‹ãƒ©ãƒ³ãƒ€ãƒ ç©´ã§ç”Ÿæˆã—ã¾ã™ã€‚</div>
    </aside>
  </main>

<script>
// ========== ç”Ÿå­˜ãƒ«ãƒ¼ãƒ«ç‰ˆï¼ˆ1ã€œ2ãƒã‚¹ç§»å‹•ï¼é£›ã³è¶Šãˆä¸å¯ï¼è„±è½åˆ¶ï¼‰ ==========

// ---- è¦ç´ å‚ç…§ ----
const svg = document.getElementById('svg');
const logEl = document.getElementById('log');
const turnEl = document.getElementById('turn');
const holeRange = document.getElementById('holeRange');
const holePercEl = document.getElementById('holePerc');
const playersPanel = document.getElementById('playersPanel');
const playersSel = document.getElementById('playersSel');
const radiusSel = document.getElementById('radiusSel');
const boardWrap = document.querySelector('.boardWrap');

// ---- å®šæ•°ãƒ»çŠ¶æ…‹ ----
const DIRS = [ [1,0],[0,1],[-1,1],[-1,0],[0,-1],[1,-1] ]; // axial 6æ–¹å‘
let RADIUS = 5;
let HOLE_PERC = 10;
let PLAYER_COUNT = 3;
const PLAYERS = ['A','B','C','D','E','F'];
const COLORS = {A:'var(--pA)',B:'var(--pB)',C:'var(--pC)',D:'var(--pD)',E:'var(--pE)',F:'var(--pF)'};

const state = {
  cells: new Map(),  // id -> {q,r,id,hole:boolean,owner:null|'A'..}
  order: [],
  turnIdx: 0,
  phase: 'place',    // 'place' or 'play'
  selected: null,
  history: [],
  playersActive: [], // ç¾åœ¨ç”Ÿå­˜ä¸­ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
  elimOrder: [],     // è„±è½é †ï¼ˆå…ˆã«è„±è½ã—ãŸäººã‹ã‚‰ï¼‰
  lastDir: {},     // ç›´å‰ã«é€²ã‚“ã æ–¹å‘ index(0..5) ã‚’è¨˜éŒ²ï¼ˆé€£ç¶šåŒæ–¹å‘ç¦æ­¢ç”¨ï¼‰
  sprintCD: {},    // ãƒ€ãƒƒã‚·ãƒ¥å¾Œã®1æ‰‹ã ã‘ 2æ­©ç¦æ­¢ï¼ˆ0:ãªã—, 1:æ¬¡æ‰‹1æ­©ç¸›ã‚Šï¼‰
};

// ---- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ----
function k(q,r){ return q+","+r }
function addLog(s){ const ts=new Date().toLocaleTimeString([], {hour12:false}); logEl.textContent += `[${ts}] ${s}\n`; logEl.scrollTop=logEl.scrollHeight }
function fmt(c){ return `(${c.q},${c.r})` }

function genHexCoords(R){
  const coords=[];
  for(let q=-R;q<=R;q++){
    const r1 = Math.max(-R, -q-R);
    const r2 = Math.min(R, -q+R);
    for(let r=r1; r<=r2; r++) coords.push([q,r]);
  }
  return coords;
}
function axialToPixel(q,r){
  const sz = 30;
  const x = sz * (Math.sqrt(3) * (q + r/2)) + 500;
  const y = sz * (3/2 * r) + 500;
  return {x,y};
}
function hexPath(cx,cy,rad){
  const pts=[]; for(let i=0;i<6;i++){ const a=Math.PI/180*(60*i-30); const x=cx+rad*Math.cos(a), y=cy+rad*Math.sin(a); pts.push([x,y]); }
  return `M ${pts.map(p=>p.join(',')).join(' L ')} Z`;
}
function createSVG(tag, attrs){ const el=document.createElementNS('http://www.w3.org/2000/svg', tag); for(const kk in attrs) el.setAttribute(kk, attrs[kk]); return el }

// ---- ç›¤ç”Ÿæˆ ----
function buildBoard(){
  state.cells.clear(); state.order.length=0; svg.innerHTML='';
  const coords = genHexCoords(RADIUS);
  const holes = new Set();
  for(const [q,r] of coords){ if(Math.random()*100 < HOLE_PERC) holes.add(k(q,r)); }

  for(const [q,r] of coords){
    const id=k(q,r); const hole = holes.has(id);
    state.cells.set(id,{q,r,id,hole,owner:null}); state.order.push(id);
  }
  for(const id of state.order){
    const c=state.cells.get(id); const {x,y}=axialToPixel(c.q,c.r);
    const path = hexPath(x,y,26);
    const isDark = ((c.q+c.r)&1)===1;
    const el = createSVG('path',{d:path, class:`hex ${isDark?'dark':''} ${c.hole?'hole':''}`});
    el.dataset.id=id; if(!c.hole) el.addEventListener('click', ()=> onClickCell(id));
    svg.appendChild(el);
  }
}

// ---- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç† ----
function clampPlayers(n){ return Math.min(5, Math.max(2, n|0)); }
function setupPlayers(n){
  const clamped = clampPlayers(n);
  state.playersActive = PLAYERS.slice(0, clamped);
  state.elimOrder = [];
  state.turnIdx = 0; state.phase='place'; state.selected=null; state.history=[];
  renderPlayersPanel();
    // ç›´å‰æ–¹å‘ï¼†ãƒ€ãƒƒã‚·ãƒ¥CDã‚’åˆæœŸåŒ–
  state.lastDir = {};
  state.sprintCD = {};
  state.playersActive.forEach(p=>{
    state.lastDir[p] = null;
    state.sprintCD[p] = 0;
  });
}
function renderPlayersPanel(){
  playersPanel.innerHTML='';
  for(const p of PLAYERS.slice(0,5)){
    const active = state.playersActive.includes(p);
    const chip = document.createElement('div'); chip.className='chip';
    chip.style.opacity = active ? 1 : 0.35;
    chip.innerHTML = `<span class="dot" style="background:${COLORS[p]}"></span>${p} ${active?'':'(è„±è½)'}`;
    playersPanel.appendChild(chip);
  }
}

// ---- æç”» ----
function render(){
  // ãƒªã‚»ãƒƒãƒˆ
  const nodes = [...svg.querySelectorAll('.hex')].filter(n=>n.dataset.id);
  nodes.forEach(n=>{ n.classList.remove('legal','path','sel'); });
  svg.querySelectorAll('.disc').forEach(n=> n.remove());

  // é§’æç”»ï¼ˆå„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1é§’ï¼‰
  for(const id of state.order){
    const c=state.cells.get(id); if(c.hole) continue; const {x,y}=axialToPixel(c.q,c.r);
    if(c.owner){
      const circ = createSVG('circle',{cx:x, cy:y, r:20, class:`disc ${c.owner}`}); svg.appendChild(circ);
    }
  }
  // ã‚¿ãƒ¼ãƒ³è¡¨ç¤º
  const turnP = state.playersActive[state.turnIdx] || '-';
  turnEl.textContent = turnP;
  renderPlayersPanel();

  // ã‚¢ãƒ•ã‚©ãƒ¼ãƒ€ãƒ³ã‚¹
  for(const id of legalCells()){ const n = svg.querySelector(`.hex[data-id="${id}"]`); if(n) n.classList.add('legal'); }
    if(state.selected){
    const n = svg.querySelector(`.hex[data-id="${state.selected}"]`);
    if(n) n.classList.add('sel');
    for(const cid of reachableCellsFrom(state.selected, turnP)){
      const nn = svg.querySelector(`.hex[data-id="${cid}"]`);
      if(nn) nn.classList.add('path');
    }
  }
}

// ---- æ‰‹ç•ªå¯èƒ½ã‚»ãƒ« / åˆ°é”ã‚»ãƒ« ----
function legalCells(){
  const turnP = state.playersActive[state.turnIdx];
  if(!turnP) return [];
  if(state.phase==='place'){
    return state.order.filter(id=>{ const c=state.cells.get(id); return !c.hole && !c.owner; });
  }else{
    const myCell = state.order.find(id=>{ const c=state.cells.get(id); return c.owner===turnP; });
    if(!myCell) return [];
    return reachableCellsFrom(myCell, turnP).length>0 ? [myCell] : [];
  }
}

function reachableCellsFrom(id, player){
  const src = state.cells.get(id); if(!src) return [];
  const res = [];
  const forbidDir = state.lastDir[player];      // ç›´å‰ã¨åŒæ–¹å‘ã¯ç¦æ­¢
  const cd = state.sprintCD[player] > 0;        // ãƒ€ãƒƒã‚·ãƒ¥å¾Œã¯2æ­©ç¦æ­¢

  for(let dirIdx=0; dirIdx<DIRS.length; dirIdx++){
    if(forbidDir === dirIdx) continue;          // é€£ç¶šåŒæ–¹å‘NG
    const d = DIRS[dirIdx];

    const step1 = state.cells.get(k(src.q + d[0], src.r + d[1]));
    if(step1 && !step1.hole && !step1.owner){
      res.push(step1.id);                       // 1æ­©ã¯å¸¸ã«å€™è£œ
      if(!cd){                                  // CDä¸­ã¯2æ­©å€™è£œã‚’å‡ºã•ãªã„
        const step2 = state.cells.get(k(step1.q + d[0], step1.r + d[1]));
        if(step2 && !step2.hole && !step2.owner){
          res.push(step2.id);                   // 2æ­©å€™è£œ
        }
      }
    }
  }
  return res;
}


function playerHasMove(p){
  const pos = state.order.find(id=>{ const c=state.cells.get(id); return c.owner===p; });
  if(!pos) return false;
  return reachableCellsFrom(pos, p).length>0;
}

// ---- ã‚¿ãƒ¼ãƒ³é€²è¡Œãƒ»è„±è½åˆ¤å®š ----
function advanceTurnSkippingDead(){
  // æ¬¡ã®ç”Ÿå­˜è€…ã§ã€ã‹ã¤å‹•ã‘ã‚‹äººã«å›ã™ã€‚å…¨å“¡ãƒã‚§ãƒƒã‚¯ã§é€£ç¶šè„±è½ã‚ã‚Šå¾—ã‚‹ã€‚
  let safety = 20; // ç„¡é™ãƒ«ãƒ¼ãƒ—ä¿é™º
  while(safety--){
    if(state.playersActive.length<=1){ endGame(); return; }
    state.turnIdx = (state.turnIdx + 1) % state.playersActive.length;
    const p = state.playersActive[state.turnIdx];
    if(playerHasMove(p)) break;
    // å‹•ã‘ãªã„ãªã‚‰å³è„±è½
    eliminatePlayer(p, 'è¡Œå‹•ä¸èƒ½');
    // turnIdxã¯ä»Šã®ä½ç½®ãŒæ¶ˆãˆã‚‹ã®ã§ã€åŒã˜ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§æ¬¡ã®äººã‚’è¦‹ã‚‹
    if(state.playersActive.length<=1){ endGame(); return; }
  }
  render();
  syncBroadcast();
}

function eliminatePlayer(p, reason='è„±è½'){
  // ç›¤ä¸Šã®é§’ã‚»ãƒ«ã‚‚æ¶ˆã—ã¦ç©´åŒ–ï¼ˆé€€å ´ï¼‰
  const pos = state.order.find(id=>{ const c=state.cells.get(id); return c.owner===p; });
  if(pos){
    const c = state.cells.get(pos);
    c.owner = null; c.hole = true;
    const node = svg.querySelector(`.hex[data-id="${pos}"]`);
    if(node) node.classList.add('hole');
  }
  // è„±è½ãƒªã‚¹ãƒˆã¸
  const idx = state.playersActive.indexOf(p);
  if(idx!==-1){
    state.playersActive.splice(idx,1);
    state.elimOrder.push(p);
    // ã‚¿ãƒ¼ãƒ³ãƒã‚¤ãƒ³ã‚¿èª¿æ•´ï¼ˆç¾åœ¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ã„ãŸäººã‚’å‰Šé™¤ã—ãŸã®ã§ã€åŒã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ¬¡ã®äººï¼‰
    if(state.turnIdx>=state.playersActive.length){ state.turnIdx = 0; }
    addLog(`${p} è„±è½ï¼ˆ${reason}ï¼‰`);
  }
}

function endGame(){
  if(state.playersActive.length===1){
    const winner = state.playersActive[0];
    const ranking = [winner, ...state.elimOrder.slice().reverse()]; // ç”Ÿå­˜é †
    const text = `çµ‚å±€: ğŸ† å‹è€… ${winner} / ç”Ÿå­˜é †: ${ranking.join(' > ')}`;
    addLog(text);
    showEnd(text);
    if (ROOM_ID) socket.emit('end', { roomId: ROOM_ID, result: text });
  }else{
    const text = `çµ‚å±€: å…¨å“¡è„±è½`;
    addLog(text);
    showEnd(text);
    if (ROOM_ID) socket.emit('end', { roomId: ROOM_ID, result: text });
  }
}

// ---- ãƒ’ã‚¹ãƒˆãƒªï¼ˆã‚¢ãƒ³ãƒ‰ã‚¥ç”¨ï¼‰ ----
function pushHistory(){
  const snapshot = {
    turnIdx: state.turnIdx, phase: state.phase, selected: state.selected,
    playersActive: [...state.playersActive], elimOrder: [...state.elimOrder],
    cells: [...state.order].map(id=>{ const c=state.cells.get(id); return {id, owner:c.owner, hole:c.hole}; }),
    lastDir: {...state.lastDir},
    sprintCD: {...state.sprintCD},
  };
  state.history.push(snapshot); if(state.history.length>200) state.history.shift();
}
function undo(){
  const s = state.history.pop(); if(!s) return;
  state.turnIdx=s.turnIdx; state.phase=s.phase; state.selected=s.selected;
  state.playersActive=[...s.playersActive]; state.elimOrder=[...s.elimOrder];
  state.lastDir = {...s.lastDir};
  state.sprintCD = {...s.sprintCD};
  for(const info of s.cells){ const c=state.cells.get(info.id); if(!c) continue; c.owner=info.owner; c.hole=info.hole; }
  addLog('ã‚¢ãƒ³ãƒ‰ã‚¥');
  redrawBoardFromState();
  render();
  syncBroadcast();
}

// ---- ã‚¯ãƒªãƒƒã‚¯å‡¦ç† ----
function onClickCell(id){
  const turnP = state.playersActive[state.turnIdx];
  const cell = state.cells.get(id);
  if(cell.hole) return;

  if(state.phase==='place'){
    if(cell.owner){ return; }
    pushHistory();
    cell.owner = turnP;
    addLog(`${turnP} åˆæœŸé…ç½® @ ${fmt(cell)}`);
    if(state.turnIdx < state.playersActive.length-1){ state.turnIdx++; }
    else { state.turnIdx=0; state.phase='play'; addLog('ãƒ—ãƒ¬ã‚¤é–‹å§‹ï¼š1ã€œ2ãƒã‚¹ç›´ç·šç§»å‹•ï¼ç§»å‹•å…ƒã¯ç©´åŒ–ï¼è¡Œå‹•ä¸èƒ½ã¯å³è„±è½'); }
    render();
    syncBroadcast();
    return;
  }

  // ãƒ—ãƒ¬ã‚¤ä¸­
  if(state.selected===id){
    state.selected=null; render(); return;
  }

  // è‡ªé§’é¸æŠ
  const myCellId = state.order.find(cid=>{ const c=state.cells.get(cid); return c.owner===turnP; });
  if(!myCellId) return;

  if(id===myCellId){
    state.selected = id; render(); return;
  }

  // ç›®çš„åœ°
  if(state.selected){
    const turnP = state.playersActive[state.turnIdx];
    const reach = new Set(reachableCellsFrom(state.selected, turnP));
        if(reach.has(id)){
      pushHistory();
      const src = state.cells.get(state.selected);
      const dst = state.cells.get(id);
      const turnP = state.playersActive[state.turnIdx];

      // é€²è¡Œæ–¹å‘ index ã¨æ­©æ•°(1 or 2) ã‚’ç®—å‡º
      let movedDir = null;
      let steps = 1;
      for(let dirIdx=0; dirIdx<DIRS.length; dirIdx++){
        const d = DIRS[dirIdx];
        if (dst.q === src.q + d[0] && dst.r === src.r + d[1]) { movedDir = dirIdx; steps = 1; break; }
        if (dst.q === src.q + 2*d[0] && dst.r === src.r + 2*d[1]) { movedDir = dirIdx; steps = 2; break; }
      }

      // å…ƒãƒã‚¹ã‚’ç©´åŒ– â†’ ç›®çš„åœ°ã¸ç§»å‹•
      src.owner = null;
      src.hole = true;
      dst.owner = turnP;

      // ç›´å‰æ–¹å‘ãƒ»ãƒ€ãƒƒã‚·ãƒ¥CDã‚’æ›´æ–°
      // ã¾ãšã€å‰å›ã®CDã‚’æ¶ˆè²»ï¼ˆCDä¸­ã¯ã“ã®ã‚¿ãƒ¼ãƒ³2æ­©ãŒå‡ºã¦ã“ãªã„ãŸã‚ steps=1 ã®ã¯ãšï¼‰
      if(state.sprintCD[turnP] > 0) state.sprintCD[turnP] = 0;
      // ä»Šå›2æ­©ãªã‚‰ã€æ¬¡æ‰‹ã¯1æ­©ç¸›ã‚Šï¼ˆCDä»˜ä¸ï¼‰
      if(steps === 2) state.sprintCD[turnP] = 1;
      // ç›´å‰æ–¹å‘ã‚’è¨˜éŒ²ï¼ˆæ¬¡æ‰‹ã®é€£ç¶šæ–¹å‘ç¦æ­¢ã«ä½¿ã†ï¼‰
      state.lastDir[turnP] = movedDir;

      addLog(`${turnP} ç§»å‹• ${fmt(src)} â†’ ${fmt(dst)}ï¼ˆ${steps}æ­©${steps===2?'ï¼šæ¬¡æ‰‹ã¯1æ­©ç¸›ã‚Š':''}ï¼åŒæ–¹å‘é€£ç¶šç¦æ­¢ï¼‰`);

      state.selected=null;
      advanceTurnSkippingDead();
      return;
    }
  }
}

// ---- å„ç¨®ã‚¤ãƒ™ãƒ³ãƒˆ ----
document.getElementById('newBtn').addEventListener('click', ()=>{
  buildBoard();
  setupPlayers(PLAYER_COUNT);
  addLog(`--- New Game --- åˆæœŸé…ç½®ã¸`);
  render();
  syncBroadcast();
});
document.getElementById('regenBtn').addEventListener('click', ()=>{
  buildBoard();
  setupPlayers(PLAYER_COUNT);
  addLog(`--- åœ°å½¢ã‚’å†ç”Ÿæˆã—ã¾ã—ãŸ --- åˆæœŸé…ç½®ã¸`);
  render();
  syncBroadcast();
});
playersSel.addEventListener('change', (e)=>{
  PLAYER_COUNT = clampPlayers(parseInt(e.target.value,10));
  setupPlayers(PLAYER_COUNT);
  render();
  syncBroadcast();
});
radiusSel.addEventListener('change', (e)=>{
  RADIUS = parseInt(e.target.value,10);
  buildBoard(); setupPlayers(PLAYER_COUNT);
  render();
  syncBroadcast();
});
document.getElementById('undoBtn').addEventListener('click', undo);
holeRange.addEventListener('input', ()=>{
  HOLE_PERC=parseInt(holeRange.value,10); holePercEl.textContent=HOLE_PERC;
});

// åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
buildBoard(); setupPlayers(PLAYER_COUNT); render(); addLog('åˆæœŸé…ç½®ï¼šç©´ãƒ»å æœ‰ä»¥å¤–ãªã‚‰ã©ã“ã§ã‚‚OK');

// ==================== ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åŒæœŸï¼ˆSocket.IOï¼‰ ====================
const socket = io();
let ROOM_ID = null;

const roomInput = document.getElementById('roomInput');
const joinBtn = document.getElementById('joinBtn');
const roleView = document.getElementById('roleView');

if (joinBtn) {
  joinBtn.addEventListener('click', ()=>{
    const id = (roomInput.value||'').trim();
    if(!id){ alert('ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›'); return; }
    ROOM_ID = id;
    socket.emit('join', { roomId: ROOM_ID });
    roleView.textContent = `å…¥å®¤ä¸­: ${ROOM_ID}`;
    syncBroadcast(); // ç¾çŠ¶ã‚’é€ã‚‹
  });
}

function serializeState(){
  return {
    turnIdx: state.turnIdx,
    phase: state.phase,
    playersActive: [...state.playersActive],
    elimOrder: [...state.elimOrder],
    order: [...state.order],
    lastDir: {...state.lastDir},
    sprintCD: {...state.sprintCD},
    cells: state.order.map(id=>{
      const c = state.cells.get(id);
      return { id, q:c.q, r:c.r, hole:c.hole, owner:c.owner };
    })
  };
}

function adoptServerState(s){
  state.turnIdx = s.turnIdx;
  state.phase = s.phase;
  state.playersActive = [...s.playersActive];
  state.elimOrder = [...s.elimOrder];
  state.order = [...s.order];
  state.lastDir = {...s.lastDir};
  state.sprintCD = {...s.sprintCD};
  state.selected = null;

  state.cells.clear();
  for(const c of s.cells){
    state.cells.set(c.id, { q:c.q, r:c.r, id:c.id, hole:c.hole, owner:c.owner });
  }
  redrawBoardFromState();
  render();
}
function redrawBoardFromState(){
  svg.innerHTML = '';
  for(const id of state.order){
    const c = state.cells.get(id);
    const {x,y} = axialToPixel(c.q, c.r);
    const path = hexPath(x,y,26);
    const isDark = ((c.q+c.r)&1)===1;
    const el = createSVG('path', { d:path, class:`hex ${isDark?'dark':''} ${c.hole?'hole':''}` });
    el.dataset.id = id;
    if(!c.hole) el.addEventListener('click', ()=> onClickCell(id));
    svg.appendChild(el);
  }
}

socket.on('state', ({ state:serverState })=>{ adoptServerState(serverState); });
socket.on('end', ({ result }) => { showEnd(result); });

function syncBroadcast(){
  if(!ROOM_ID) return;
  socket.emit('state', { roomId: ROOM_ID, state: serializeState() });
}

// ========== End Game Modal ==========
function showEnd(resultText) {
  const colorMap = {A:"ğŸŸ¦",B:"ğŸŸ¨",C:"ğŸŸ©",D:"ğŸŸª",E:"ğŸŸ¥",F:"ğŸŸ«"};
  const modal = document.getElementById("endModal");
  const pre = document.getElementById("endResult");
  if (pre) {
    const survivors = state.playersActive.join(" ");
    const elim = state.elimOrder.join(" â†’ ");
    const hero = state.playersActive.length===1 ? `${colorMap[state.playersActive[0]]||''} ${state.playersActive[0]}` : 'â€”';
    pre.textContent = `${resultText}\n\nã€ã‚µãƒãƒªã€‘\nç”Ÿå­˜: ${survivors||'ãªã—'}\nè„±è½é †: ${elim||'ãªã—'}\nå‹è€…: ${hero}`;
  }
  if (modal) modal.style.display = "flex";
}
function hideEnd() {
  const modal = document.getElementById("endModal");
  if (modal) modal.style.display = "none";
}
</script>

<!-- End Game Modal -->
<div id="endModal" style="position:fixed; inset:0; background:rgba(0,0,0,.75); display:none; align-items:center; justify-content:center; z-index:100;">
  <div style="background:#111827; padding:24px; border-radius:14px; max-width:90%; text-align:center;">
    <h2 style="margin:0 0 12px; font-size:22px;">ã‚²ãƒ¼ãƒ çµ‚äº†</h2>
    <pre id="endResult" style="white-space:pre-wrap; margin-bottom:18px; font-size:16px;"></pre>
    <button id="closeEndBtn" onclick="hideEnd()" style="padding:10px 20px; border-radius:10px;">é–‰ã˜ã‚‹</button> 
  </div>
</div>

</body>
</html>
