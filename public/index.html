<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Territory Masters â€” 2ã€œ5äºº / å…­è§’ç›¤ / ãƒ©ãƒ³ãƒ€ãƒ åœ°å½¢ / ä»»æ„é…ç½®ãƒ»è‡ªç”±åˆ†å‰² / çµ‚ç«¯ç§»å‹• / ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–</title>

<!-- â˜… è¿½åŠ ï¼šSocket.IO ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³åŒæœŸç”¨ï¼‰ -->
<script src="/socket.io/socket.io.js"></script>

<style>
  :root{ --bg:#0f1226; --panel:#121730; --text:#e5e7eb; --muted:#94a3b8; --grid:#1e2447; --ok:#10b981; --warn:#ef4444;
         --pA:#60a5fa; --pB:#f59e0b; --pC:#34d399; --pD:#f472b6; --pE:#f87171; --pF:#a78bfa }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:
    radial-gradient(1200px 800px at 10% -10%, rgba(99,102,241,.25), transparent 60%),
    radial-gradient(1200px 800px at 110% 0%, rgba(56,189,248,.15), transparent 60%), var(--bg); color:var(--text);
    display:flex; flex-direction:column; gap:12px; padding:16px; padding-bottom:90px; /* ä½™ç™½: HUD */}
  header{display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap}
  h1{margin:0; font-size:20px}
  .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  button, select{background:linear-gradient(180deg,#243065,#1a224f); border:1px solid rgba(255,255,255,.08); color:var(--text); padding:10px 12px; border-radius:12px; font-weight:700}
  button{cursor:pointer}
  button:hover{filter:brightness(1.06)}
  main{display:grid; grid-template-columns: 1fr 380px; gap:12px}
  @media (max-width:980px){ main{grid-template-columns: 1fr} }
  .boardWrap{
  position:relative; /* è¿½åŠ  */
  background:var(--panel);
  border:1px solid rgba(255,255,255,.08);
  border-radius:14px;
  padding:10px;
  display:flex; justify-content:center; align-items:center
}
  svg{width:min(96vw,860px); height:auto; aspect-ratio:1/1; touch-action:manipulation}
  .hex{stroke:#0b102a; stroke-width:1.2; fill:#18304a; transition:filter .15s}
  .hex.dark{fill:#14263d}
  .hex.border{filter:drop-shadow(0 0 4px rgba(255,255,255,.08))}
  .hex.hole{fill:#0b1030}
  .hex.legal{stroke-dasharray:4 3; stroke:#9ca3af}
  .hex.path{stroke:#6ee7b7}
  .disc{pointer-events:none}
  .A{fill:var(--pA)} .B{fill:var(--pB)} .C{fill:var(--pC)} .D{fill:var(--pD)} .E{fill:var(--pE)} .F{fill:var(--pF)}
  .sel{stroke:#fcd34d; stroke-width:3}

  .side{background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:10px}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .stat{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:8px 10px; font-weight:700}
  .muted{color:var(--muted)}
  .log{min-height:140px; max-height:40vh; overflow:auto; background:#0b1030; border:1px solid rgba(255,255,255,.1); border-radius:12px; padding:10px; font-family:ui-monospace, Menlo, Consolas, monospace; font-size:13px}
  .players{display:flex; gap:8px; flex-wrap:wrap}
  .chip{display:inline-flex; gap:6px; align-items:center; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:999px; padding:6px 10px; font-weight:700}
  .dot{width:12px; height:12px; border-radius:50%}
/* åˆ†å‰²ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ */
.split-popover{
  position:absolute;
  transform:translate(-50%,-100%); /* ä¸­å¿ƒä¸Šã«å‡ºã™ */
  background:rgba(12,16,40,.96);
  border:1px solid rgba(255,255,255,.12);
  border-radius:12px;
  padding:8px 10px;
  display:none;
  gap:8px;
  align-items:center;
  box-shadow:0 6px 18px rgba(0,0,0,.35);
  z-index:20;
  white-space:nowrap;
}
.split-popover label{ font-weight:800; margin-right:6px }
.split-popover select{
  background:linear-gradient(180deg,#243065,#1a224f);
  border:1px solid rgba(255,255,255,.12);
  color:var(--text); padding:8px 10px; border-radius:10px; font-weight:800;
}

  /* ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– */
  @media (max-width:720px){
    h1{font-size:18px}
    button, select{padding:12px 14px; border-radius:14px}
    .stat{padding:10px 12px}
    .log{max-height:30vh}
  }
  /* ç”»é¢ä¸‹ã®HUDï¼ˆã‚¹ãƒãƒ›ç”¨æ“ä½œãƒãƒ¼ï¼‰ */
  .hud{position:fixed; left:0; right:0; bottom:0; padding:10px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left); background:rgba(8,10,30,.8); backdrop-filter: blur(8px); border-top:1px solid rgba(255,255,255,.08); display:none; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap; z-index:50}
  .hud .pill{display:flex; gap:8px; align-items:center; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); padding:10px 12px; border-radius:999px; font-weight:800}
  .hud button, .hud select{padding:12px 14px; border-radius:14px}
  @media (max-width:980px){ .hud{display:flex} }
</style>
</head>
<body>
  <header>
    <h1>Territory Mastersï¼ˆ<span class="muted"> 2ã€œ5äºº / å…­è§’ç›¤ / ãƒ©ãƒ³ãƒ€ãƒ åœ°å½¢</span>ï¼‰</h1>
    <div class="controls">
      <button id="newBtn" aria-label="ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ ">ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ </button>
      <button id="regenBtn" aria-label="åœ°å½¢å†ç”Ÿæˆ">åœ°å½¢å†ç”Ÿæˆ</button>
      <label class="stat">äººæ•°
 <select id="playersSel" aria-label="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°">
  <option value="2">2äºº</option>
  <option value="3" selected>3äºº</option>
  <option value="4">4äºº</option>
  <option value="5">5äºº</option>
</select>
      </label>
      <label class="stat">ç›¤ã‚µã‚¤ã‚ºï¼ˆåŠå¾„ï¼‰
        <select id="radiusSel" aria-label="ç›¤ã®åŠå¾„">
          <option value="4">å° (R=4)</option>
          <option value="5" selected>ä¸­ (R=5)</option>
          <option value="6">å¤§ (R=6)</option>
        </select>
      </label>
      <label class="stat">ç©´% <span id="holePerc">10</span>
        <input id="holeRange" type="range" min="0" max="30" step="1" value="10" aria-label="ç©´ã®å‰²åˆ" />
      </label>
      <span class="stat">æ‰‹ç•ª: <span id="turn">A</span></span>
      <span class="stat">åˆæœŸã‚¹ã‚¿ãƒƒã‚¯: <span id="initStack">-</span></span>
    </div>

    <!-- â˜… è¿½åŠ ï¼šã‚ªãƒ³ãƒ©ã‚¤ãƒ³å…¥å®¤UIï¼ˆç°¡æ˜“ï¼‰ -->
    <div class="controls">
      <input id="roomInput" placeholder="ãƒ«ãƒ¼ãƒ IDï¼ˆä¾‹: abc123ï¼‰" style="padding:10px;border-radius:10px;border:1px solid #fff2" />
      <button id="joinBtn" aria-label="å…¥å®¤">å…¥å®¤</button>
      <span id="roleView" class="muted"></span>
    </div>
  </header>

  <main>
    <div class="boardWrap">
      <svg id="svg" viewBox="0 0 1000 1000" role="img" aria-label="hex board"></svg>
    </div>

    <aside class="side">
      <div class="players" id="playersPanel"></div>
      <div class="row"><div class="stat">ãƒ«ãƒ¼ãƒ«è¦ç´„ï¼š<b>åˆæ‰‹ã¯ç›¤ä¸Šã®ã©ã“ã§ã‚‚OK</b>ï¼ˆç©´ãƒ»å æœ‰ä»¥å¤–ï¼‰ã€‚åˆæœŸã‚¹ã‚¿ãƒƒã‚¯ã¯<b>æœ‰åŠ¹ãƒ‘ãƒãƒ«ç·æ•° Ã· ãƒ—ãƒ¬ã‚¤äººæ•°</b>ï¼ˆå°æ•°åˆ‡æ¨ã¦ï¼‰ã€‚æ‰‹ç•ªã§ã¯è‡ªåˆ†ã®ã‚¹ã‚¿ãƒƒã‚¯ã‚’<b>è‡ªç”±ã«åˆ†å‰²(1ã€œn-1é¸æŠ)</b>ã—ã€<b>ä¸€ç›´ç·šã«çªãå½“ãŸã‚Šï¼ˆéšœå®³ç›´å‰ï¼‰ã¾ã§</b>ç§»å‹•ã—ã¾ã™ï¼ˆé€”ä¸­åœæ­¢ä¸å¯ï¼‰ã€‚å…¨å“¡ãŒå‹•ã‘ãªããªã£ãŸã‚‰çµ‚äº†ã€‚æœ€å¤šæ”¯é…ã§å‹ã¡ã€‚</div></div>
      <div class="row">
        <div class="stat">åˆ†å‰²æšæ•°</div>
        <select id="splitSelect" aria-label="åˆ†å‰²æšæ•°"></select>
      </div>
      <div class="row">
        <button id="undoBtn">ã‚¢ãƒ³ãƒ‰ã‚¥</button>
        <button id="passBtn">ãƒ‘ã‚¹</button>
      </div>
      <div class="log" id="log"></div>
      <div class="muted">æ³¨: ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã®å…­è§’ç›¤ï¼‹ãƒ©ãƒ³ãƒ€ãƒ ç©´ã«ã—ã¦ã„ã¾ã™ã€‚</div>
    </aside>
  </main>

  <!-- ãƒ¢ãƒã‚¤ãƒ«HUDï¼ˆä¸‹éƒ¨å›ºå®šï¼‰ -->
  <div class="hud" role="toolbar" aria-label="ãƒ¢ãƒã‚¤ãƒ«æ“ä½œãƒãƒ¼">
    <div class="pill">æ‰‹ç•ª: <span id="hudTurn">A</span></div>
    <div class="pill">åˆ†å‰²: <select id="hudSplit"></select></div>
    <button id="hudUndo">ã‚¢ãƒ³ãƒ‰ã‚¥</button>
    <button id="hudPass">ãƒ‘ã‚¹</button>
  </div>

<script>
// ============== Territory Mastersï¼ˆ2ã€œ5äººå¯¾å¿œ / è¿‘æ¥ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼åˆ†å‰²UI / ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åŒæœŸï¼‰ ==============

// ---- è¦ç´ å‚ç…§ ----
const svg = document.getElementById('svg');
const logEl = document.getElementById('log');
const turnEl = document.getElementById('turn');
const hudTurn = document.getElementById('hudTurn');
const holeRange = document.getElementById('holeRange');
const holePercEl = document.getElementById('holePerc');
const playersPanel = document.getElementById('playersPanel');
const initStackEl = document.getElementById('initStack');
const splitSelect = document.getElementById('splitSelect'); // ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«
const hudSplit = document.getElementById('hudSplit');       // HUDï¼ˆãƒ¢ãƒã‚¤ãƒ«ï¼‰
const playersSel = document.getElementById('playersSel');
const radiusSel = document.getElementById('radiusSel');

// ç›¤ãƒ©ãƒƒãƒ‘ï¼ˆãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ç”¨ã®ç›¸å¯¾åŸºæº–ã«ã™ã‚‹ï¼‰
const boardWrap = document.querySelector('.boardWrap');
if (boardWrap && getComputedStyle(boardWrap).position === 'static') {
  boardWrap.style.position = 'relative';
}

// ---- å®šæ•°ãƒ»çŠ¶æ…‹ ----
const DIRS = [ [1,0],[0,1],[-1,1],[-1,0],[0,-1],[1,-1] ]; // axial 6æ–¹å‘
let RADIUS = 5; // åŠå¾„
let HOLE_PERC = 10; // %
let PLAYER_COUNT = 3; // 2ã€œ5 ã®ç¯„å›²ã§ clamp
const PLAYERS = ['A','B','C','D','E','F']; // slice(0, n) ã§åˆ©ç”¨ï¼ˆJSå´ã§æœ€å¤§5ã«åˆ¶é™ï¼‰
const COLORS = {A:'var(--pA)',B:'var(--pB)',C:'var(--pC)',D:'var(--pD)',E:'var(--pE)',F:'var(--pF)'};

const state = {
  cells: new Map(), // key: k(q,r) -> {q,r,id, hole:boolean, owner:null|'A'|'B'|'C'|'D'|'E'|'F', stack:0}
  order: [],
  turnIdx: 0,
  phase: 'place', // 'place' or 'play'
  selected: null,
  history: [],
  left: {},
  playersActive: [],
  initStack: 16,
  playableCount: 0,
};

// ---- è¿‘æ¥åˆ†å‰²ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰ ----
const splitPopover = document.createElement('div');
splitPopover.id = 'splitPopover';
splitPopover.className = 'split-popover';
splitPopover.style.cssText = `
  position:absolute; transform:translate(-50%,-100%);
  background:rgba(12,16,40,.96); border:1px solid rgba(255,255,255,.12);
  border-radius:12px; padding:8px 10px; display:none; gap:8px; align-items:center;
  box-shadow:0 6px 18px rgba(0,0,0,.35); z-index:20; white-space:nowrap;
`;
splitPopover.innerHTML = `
  <label for="localSplit" style="font-weight:800; margin-right:6px">åˆ†å‰²</label>
  <select id="localSplit" aria-label="åˆ†å‰²æšæ•°(è¿‘æ¥)" style="
    background:linear-gradient(180deg,#243065,#1a224f);
    border:1px solid rgba(255,255,255,.12);
    color:var(--text); padding:8px 10px; border-radius:10px; font-weight:800;
  "></select>
`;
boardWrap.appendChild(splitPopover);
const localSplit = splitPopover.querySelector('#localSplit');

// ---- å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ----
function k(q,r){ return q+","+r }
function addLog(s){ const ts=new Date().toLocaleTimeString([], {hour12:false}); logEl.textContent += `[${ts}] ${s}\n`; logEl.scrollTop=logEl.scrollHeight }
function fmt(c){ return `(${c.q},${c.r})` }
function hudIsActive(){ return window.matchMedia('(max-width: 980px)').matches }

// ---- ç›¤ç”Ÿæˆ ----
function genHexCoords(R){
  const coords=[];
  for(let q=-R;q<=R;q++){
    const r1 = Math.max(-R, -q-R);
    const r2 = Math.min(R, -q+R);
    for(let r=r1; r<=r2; r++) coords.push([q,r]);
  }
  return coords;
}

function axialToPixel(q,r){
  const sz = 30; // sizeï¼ˆSVGã¯viewBoxã§ã‚¹ã‚±ãƒ¼ãƒ«ã•ã‚Œã‚‹ã®ã§OKï¼‰
  const x = sz * (Math.sqrt(3) * (q + r/2)) + 500;
  const y = sz * (3/2 * r) + 500;
  return {x,y};
}
function hexPath(cx,cy,rad){
  const pts=[]; for(let i=0;i<6;i++){ const a=Math.PI/180*(60*i-30); const x=cx+rad*Math.cos(a), y=cy+rad*Math.sin(a); pts.push([x,y]); }
  return `M ${pts.map(p=>p.join(',')).join(' L ')} Z`;
}
function createSVG(tag, attrs){ const el=document.createElementNS('http://www.w3.org/2000/svg', tag); for(const kk in attrs) el.setAttribute(kk, attrs[kk]); return el }
function neighborIds(c){ return DIRS.map(d=> k(c.q+d[0], c.r+d[1])) }

function buildBoard(){
  state.cells.clear(); state.order.length=0; svg.innerHTML='';
  const coords = genHexCoords(RADIUS);
  // ãƒ©ãƒ³ãƒ€ãƒ ç©´
  const holes = new Set();
  for(const [q,r] of coords){ if(Math.random()*100 < HOLE_PERC) holes.add(k(q,r)); }

  // ç™»éŒ²
  for(const [q,r] of coords){
    const id=k(q,r); const hole = holes.has(id);
    state.cells.set(id,{q,r,id,hole,owner:null,stack:0}); state.order.push(id);
  }
  // æç”»
  for(const id of state.order){
    const c=state.cells.get(id); const {x,y}=axialToPixel(c.q,c.r);
    const path = hexPath(x,y,26);
    const isDark = ((c.q+c.r)&1)===1;
    const el = createSVG('path',{d:path, class:`hex ${isDark?'dark':''} ${c.hole?'hole':''}`});
    el.dataset.id=id; if(!c.hole) el.addEventListener('click', ()=> onClickCell(id));
    svg.appendChild(el);
  }
  // ãƒ—ãƒ¬ã‚¤å¯èƒ½ã‚»ãƒ«æ•°
  state.playableCount = state.order.filter(id=>{ const c=state.cells.get(id); return !c.hole; }).length;
}

// ---- ã‚²ãƒ¼ãƒ ç®¡ç† ----
function clampPlayers(n){
  // UIãŒ6äººã®ã¾ã¾ã§ã‚‚ 2ã€œ5 ã«çŸ¯æ­£
  return Math.min(5, Math.max(2, n|0));
}

function setupPlayers(n){
  const clamped = clampPlayers(n);
  state.playersActive = PLAYERS.slice(0, clamped);
  // åˆæœŸã‚¹ã‚¿ãƒƒã‚¯ = æœ‰åŠ¹ãƒ‘ãƒãƒ«ç·æ•° / ãƒ—ãƒ¬ã‚¤äººæ•°ï¼ˆåˆ‡ã‚Šæ¨ã¦ã€æœ€ä½2ï¼‰
  state.initStack = Math.max(2, Math.floor(state.playableCount / state.playersActive.length));
  initStackEl.textContent = state.initStack;
  state.left = {}; state.playersActive.forEach(p=> state.left[p]=state.initStack);
  state.turnIdx = 0; state.phase='place'; state.selected=null; state.history=[];
  renderPlayersPanel();
}

function renderPlayersPanel(){
  playersPanel.innerHTML='';
  for(const p of state.playersActive){
    const chip = document.createElement('div'); chip.className='chip';
    chip.innerHTML = `<span class="dot" style="background:${COLORS[p]}"></span>${p} <span class="muted">æ”¯é…</span> <b id="own_${p}">0</b>`;
    playersPanel.appendChild(chip);
  }
}

function updateOwnershipStats(){
  const counts={}; state.playersActive.forEach(p=> counts[p]=0);
  for(const id of state.order){ const c=state.cells.get(id); if(c.hole) continue; if(c.owner && counts[c.owner]!=null) counts[c.owner]++; }
  for(const p of state.playersActive){ const el = document.getElementById('own_'+p); if(el) el.textContent = counts[p]||0; }
}

function resetGame(){
  state.selected=null; state.history=[];
  for(const id of state.order){ const c=state.cells.get(id); c.owner=null; c.stack=0; }
  state.phase='place'; state.turnIdx=0; state.playersActive.forEach(p=> state.left[p]=state.initStack);
  render(); addLog(`--- New Game --- ã©ã“ã§ã‚‚åˆæœŸé…ç½®OKï¼ˆç©´ãƒ»å æœ‰ä»¥å¤–ï¼‰ã€‚åˆæœŸã‚¹ã‚¿ãƒƒã‚¯=${state.initStack}`);
  hideSplitPopover();
  syncBroadcast();
}

function render(){
  // ã‚»ãƒ«å¤–è¦³
  const nodes = [...svg.querySelectorAll('.hex')].filter(n=>n.dataset.id);
  nodes.forEach(n=>{ n.classList.remove('legal','path','sel'); });
  // æ—¢å­˜ãƒ‡ã‚£ã‚¹ã‚¯æ¶ˆå»
  svg.querySelectorAll('.disc').forEach(n=> n.remove());

  for(const id of state.order){
    const c=state.cells.get(id); if(c.hole) continue; const {x,y}=axialToPixel(c.q,c.r);
    if(c.owner){
      const circ = createSVG('circle',{cx:x, cy:y, r:20, class:`disc ${c.owner}`}); svg.appendChild(circ);
      if(c.stack>1){ const t = createSVG('text',{x:x, y:y+5, 'text-anchor':'middle', 'font-size':'15', fill:'#0b102a', class:'disc'}); t.textContent=c.stack; svg.appendChild(t); }
    }
  }
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  const turnP = state.playersActive[state.turnIdx];
  turnEl.textContent = turnP; hudTurn.textContent = turnP;
  updateOwnershipStats();

  // ã‚¢ãƒ•ã‚©ãƒ¼ãƒ€ãƒ³ã‚¹
  const legals = legalCells();
  for(const id of legals){ const n = svg.querySelector(`.hex[data-id="${id}"]`); if(n) n.classList.add('legal'); }
  if(state.selected){ const n = svg.querySelector(`.hex[data-id="${state.selected}"]`); if(n) n.classList.add('sel'); showPaths(state.selected); }
}

function legalCells(){
  const turnP = state.playersActive[state.turnIdx];
  if(state.phase==='place'){
    // ç›¤ä¸Šã©ã“ã§ã‚‚ï¼ˆç©´ãƒ»å æœ‰ä»¥å¤–ï¼‰
    return state.order.filter(id=>{ const c=state.cells.get(id); return !c.hole && !c.owner; });
  } else {
    // å‹•ã‹ã›ã‚‹è‡ªã‚¹ã‚¿ãƒƒã‚¯
    return state.order.filter(id=>{ const c=state.cells.get(id); return !c.hole && c.owner===turnP && c.stack>1; });
  }
}

function reachableCellsFrom(id){
  // å„æ–¹å‘ã®çµ‚ç«¯ï¼ˆéšœå®³ç›´å‰ã®æœ€é ãƒã‚¹ï¼‰ã®ã¿ï¼ˆé€”ä¸­åœæ­¢ä¸å¯ï¼‰
  const src = state.cells.get(id); const res=[];
  for(const d of DIRS){
    let q=src.q, r=src.r; let last=null;
    while(true){ q+=d[0]; r+=d[1]; const nx = state.cells.get(k(q,r)); if(!nx || nx.hole) break; if(nx.owner){ break; } last=nx; }
    if(last) res.push(last.id);
  }
  return res;
}

function showPaths(id){
  const ids = reachableCellsFrom(id);
  for(const cid of ids){ const n = svg.querySelector(`.hex[data-id="${cid}"]`); if(n) n.classList.add('path'); }
}

function populateSplitOptions(max){
  function fill(sel){
    if(!sel) return;
    sel.innerHTML='';
    const upper = Math.max(1, max);
    for(let i=1;i<=upper;i++){ const opt=document.createElement('option'); opt.value=String(i); opt.textContent=String(i); sel.appendChild(opt); }
  }
  fill(splitSelect); fill(hudSplit);
}

function fillLocalSplit(max){
  localSplit.innerHTML = '';
  const upper = Math.max(1, max);
  for(let i=1;i<=upper;i++){
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = String(i);
    localSplit.appendChild(opt);
  }
  // æ—¢å­˜UIã¨åŒæœŸ
  if(splitSelect){ splitSelect.innerHTML = localSplit.innerHTML; splitSelect.value = localSplit.value; }
  if(hudSplit){    hudSplit.innerHTML    = localSplit.innerHTML; hudSplit.value    = localSplit.value; }
}

function showSplitPopoverAtCell(cellId){
  if(!cellId) return hideSplitPopover();
  const c = state.cells.get(cellId);
  if(!c) return hideSplitPopover();

  fillLocalSplit(Math.max(1, (c.stack||0)-1));

  // SVG viewBox(0..1000) -> ç”»é¢ãƒ”ã‚¯ã‚»ãƒ« â†’ boardWrapåŸºæº–
  const {x,y} = axialToPixel(c.q, c.r);
  const rect = svg.getBoundingClientRect();
  const px = rect.left + (x/1000) * rect.width;
  const py = rect.top  + (y/1000) * rect.height;

  const bw = boardWrap.getBoundingClientRect();
  const lx = px - bw.left;
  const ly = py - bw.top;

  splitPopover.style.left = `${lx}px`;
  splitPopover.style.top  = `${ly}px`;
  splitPopover.style.display = 'flex';
}
function hideSplitPopover(){
  splitPopover.style.display = 'none';
}

// ç”»é¢ã‚µã‚¤ã‚ºå¤‰åŒ–ã§å†é…ç½®
window.addEventListener('resize', ()=>{
  if(splitPopover.style.display !== 'none' && state.selected){
    showSplitPopoverAtCell(state.selected);
  }
});

// ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼å¤‰æ›´æ™‚ã¯æ—¢å­˜ã‚»ãƒ¬ã‚¯ã‚¿ã‚‚åŒæœŸ
localSplit.addEventListener('change', ()=>{
  if(splitSelect) splitSelect.value = localSplit.value;
  if(hudSplit)    hudSplit.value    = localSplit.value;
});

// ---- ã‚¿ãƒ¼ãƒ³ãƒ»çµ‚äº† ----
function nextTurn(){
  state.turnIdx = (state.turnIdx+1) % state.playersActive.length;
  render();
  hideSplitPopover();
  if (isEnd()) { endGame(); return; }
  syncBroadcast();
}

function isEnd(){
  // å‚åŠ è€…ã®èª°ã‚‚å‹•ã‹ã›ã‚‹ã‚¹ã‚¿ãƒƒã‚¯ãŒç„¡ã„
  return !state.playersActive.some(p=> canPlayerMove(p));
}
function canPlayerMove(p){
  return state.order.some(id=>{ const c=state.cells.get(id); return c && !c.hole && c.owner===p && c.stack>1 && hasMove(c); });
}
function hasMove(src){
  for(const d of DIRS){ let q=src.q, r=src.r; while(true){ q+=d[0]; r+=d[1]; const c=state.cells.get(k(q,r)); if(!c || c.hole) break; if(c.owner){ break; } return true; } }
  return false;
}
function resultString(){
  const counts={}; state.playersActive.forEach(p=> counts[p]=0);
  for(const id of state.order){ const c=state.cells.get(id); if(c && !c.hole && c.owner) counts[c.owner]++; }
  const sorted = Object.entries(counts).sort((a,b)=> b[1]-a[1]);
  const top = sorted[0][1]; const winners = sorted.filter(([_,v])=> v===top).map(([k])=>k).join(',');
  return `çµ‚å±€: ${sorted.map(([p,v])=>`${p} ${v}`).join(' / ')} â†’ å‹è€…: ${winners}`;
}
function endGame(){
  const text = resultString();
  addLog(text);

  // è‡ªåˆ†ã¯å³è¡¨ç¤º
  showEnd(text);

  // å‚åŠ è€…ã¸çµæœã‚’é…ä¿¡ï¼ˆâ€»ã€Œé–‰ã˜ã‚‹ã€ã¯åŒæœŸã—ãªã„ï¼‰
  if (ROOM_ID) {
    socket.emit('end', { roomId: ROOM_ID, result: text });
  }
}

// ---- ãƒ’ã‚¹ãƒˆãƒª ----
function pushHistory(){
  const snapshot = {
    turnIdx: state.turnIdx, phase: state.phase, selected: state.selected,
    left: {...state.left}, playersActive: [...state.playersActive], initStack: state.initStack,
    cells: [...state.order].map(id=>{ const c=state.cells.get(id); return {id, owner:c.owner, stack:c.stack, hole:c.hole}; }),
  };
  state.history.push(snapshot); if(state.history.length>200) state.history.shift();
}
function undo(){
  const s = state.history.pop(); if(!s) return;
  state.turnIdx=s.turnIdx; state.phase=s.phase; state.selected=s.selected; state.left=s.left;
  state.playersActive=s.playersActive; state.initStack=s.initStack;
  for(const info of s.cells){ const c=state.cells.get(info.id); if(!c) continue; c.owner=info.owner; c.stack=info.stack; c.hole=info.hole; }
  addLog('ã‚¢ãƒ³ãƒ‰ã‚¥');
  render();
  hideSplitPopover();
  syncBroadcast();
}

function pass(){
  const turnP = state.playersActive[state.turnIdx];
  if(state.phase==='place'){ addLog('é…ç½®ãƒ•ã‚§ã‚¤ã‚ºã§ã¯ãƒ‘ã‚¹ä¸å¯'); return; }
  if(canPlayerMove(turnP)){ addLog('ã¾ã å‹•ã‘ã¾ã™ï¼ˆãƒ‘ã‚¹ä¸å¯ï¼‰'); return; }
  addLog(`${turnP} ãƒ‘ã‚¹`);
  hideSplitPopover();
  nextTurn();
}

// ---- ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼ˆåˆ†å‰²ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼çµ±åˆï¼‰ ----
function onClickCell(id){
  const turnP = state.playersActive[state.turnIdx];
  const cell = state.cells.get(id);
  if(cell.hole) return;

  if(state.phase==='place'){
    if(cell.owner){ return; }
    pushHistory();
    cell.owner = turnP; cell.stack = state.initStack; state.left[turnP]=0;
    addLog(`${turnP} åˆæœŸé…ç½®(${state.initStack}) @ ${fmt(cell)}`);
    if(state.turnIdx < state.playersActive.length-1){ state.turnIdx++; }
    else { state.turnIdx=0; state.phase='play'; addLog('ãƒ—ãƒ¬ã‚¤é–‹å§‹ï¼šåˆ†å‰² â†’ ç›´ç·šã®çµ‚ç«¯ã«ç§»å‹•'); }
    render();
    hideSplitPopover();
    syncBroadcast();
    return;
  }

  // ãƒ—ãƒ¬ã‚¤ä¸­
  if(state.selected===id){
    state.selected=null; render();
    hideSplitPopover();
    return;
  }

  const legals = new Set(legalCells());
  if(legals.has(id)){
    state.selected=id; // ã‚¹ã‚¿ãƒƒã‚¯é¸æŠ
    const c=state.cells.get(id);
    populateSplitOptions(c.stack-1);
    render();
    showSplitPopoverAtCell(id); // è¿‘æ¥ã«è¡¨ç¤º
  } else if(state.selected){
    // ç›®çš„åœ°ï¼ˆçµ‚ç«¯ã®ã¿ï¼‰
    const reach = new Set(reachableCellsFrom(state.selected));
    if(reach.has(id)){
      const src = state.cells.get(state.selected);

      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ â†’ HUD â†’ ã‚µã‚¤ãƒ‰ ã®å„ªå…ˆé †ã§å–å¾—
      let moveCount;
      if(splitPopover.style.display !== 'none'){
        moveCount = parseInt(localSplit.value, 10);
      }else if(hudIsActive()){
        moveCount = parseInt(hudSplit.value, 10);
      }else{
        moveCount = parseInt(splitSelect.value, 10);
      }

      if(Number.isNaN(moveCount) || moveCount<1 || moveCount>=src.stack){ return; }
      pushHistory();
      src.stack -= moveCount;
      cell.owner = turnP; cell.stack = (cell.stack||0) + moveCount;
      addLog(`${turnP} åˆ†å‰²${moveCount}/${src.stack+moveCount} â†’ ç§»å‹• @ ${fmt(cell)}`);
      state.selected=null;
      render();
      hideSplitPopover();
      nextTurn(); // å†…éƒ¨ã§ syncBroadcast() å®Ÿè¡Œ
    }
  }
}

// ---- ã‚¤ãƒ™ãƒ³ãƒˆ ----
document.getElementById('newBtn').addEventListener('click', ()=>{
  buildBoard();
  setupPlayers(PLAYER_COUNT);
  resetGame();
});
document.getElementById('regenBtn').addEventListener('click', ()=>{
  buildBoard();
  setupPlayers(PLAYER_COUNT);
  resetGame();
});
playersSel.addEventListener('change', (e)=>{
  PLAYER_COUNT = clampPlayers(parseInt(e.target.value,10));
  setupPlayers(PLAYER_COUNT);
  resetGame();
});
radiusSel.addEventListener('change', (e)=>{
  RADIUS = parseInt(e.target.value,10);
  buildBoard(); setupPlayers(PLAYER_COUNT); resetGame();
});
document.getElementById('undoBtn').addEventListener('click', undo);
document.getElementById('passBtn').addEventListener('click', pass);
document.getElementById('hudUndo').addEventListener('click', undo);
document.getElementById('hudPass').addEventListener('click', pass);
holeRange.addEventListener('input', ()=>{
  HOLE_PERC=parseInt(holeRange.value,10); holePercEl.textContent=HOLE_PERC;
});

// åˆæœŸ
buildBoard(); setupPlayers(PLAYER_COUNT); resetGame();

// ==================== ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åŒæœŸï¼ˆSocket.IOï¼‰ ====================
const socket = io();
let ROOM_ID = null;

// å…¥å®¤UI
const roomInput = document.getElementById('roomInput');
const joinBtn = document.getElementById('joinBtn');
const roleView = document.getElementById('roleView');

if (joinBtn) {
  joinBtn.addEventListener('click', ()=>{
    const id = (roomInput.value||'').trim();
    if(!id){ alert('ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›'); return; }
    ROOM_ID = id;
    socket.emit('join', { roomId: ROOM_ID });
    roleView.textContent = `å…¥å®¤ä¸­: ${ROOM_ID}`;
    // è‡ªåˆ†ã®ç¾çŠ¶stateã‚’æœ€åˆã«æŠ•ã’ã¦ãŠãï¼ˆä»–ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒè¿½å¾“ï¼‰
    syncBroadcast();
  });
}

// é€å—ä¿¡ç”¨ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
function serializeState(){
  return {
    turnIdx: state.turnIdx,
    phase: state.phase,
    playersActive: [...state.playersActive],
    order: [...state.order],
    initStack: state.initStack,
    cells: state.order.map(id=>{
      const c = state.cells.get(id);
      return { id, q:c.q, r:c.r, hole:c.hole, owner:c.owner, stack:c.stack };
    })
  };
}

function adoptServerState(s){
  state.turnIdx = s.turnIdx;
  state.phase = s.phase;
  state.playersActive = [...s.playersActive];
  state.order = [...s.order];
  state.initStack = s.initStack;
  state.selected = null;

  state.cells.clear();
  for(const c of s.cells){
    state.cells.set(c.id, { q:c.q, r:c.r, id:c.id, hole:c.hole, owner:c.owner, stack:c.stack });
  }

  redrawBoardFromState();
  render();
  hideSplitPopover();
}

function redrawBoardFromState(){
  svg.innerHTML = '';
  for(const id of state.order){
    const c = state.cells.get(id);
    const {x,y} = axialToPixel(c.q, c.r);
    const path = hexPath(x,y,26);
    const isDark = ((c.q+c.r)&1)===1;
    const el = createSVG('path', {
      d:path,
      class:`hex ${isDark?'dark':''} ${c.hole?'hole':''}`
    });
    el.dataset.id = id;
    if(!c.hole) el.addEventListener('click', ()=> onClickCell(id));
    svg.appendChild(el);
  }
}

// ã‚µãƒ¼ãƒã‹ã‚‰ã®é…ä¿¡ã‚’å—ã‘å–ã‚‹
socket.on('state', ({ state:serverState })=>{
  adoptServerState(serverState);
});

// ã‚µãƒ¼ãƒã‹ã‚‰çµ‚å±€çµæœãŒå±Šã„ãŸã‚‰ã€è‡ªåˆ†ã®ç”»é¢ã«ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
socket.on('end', ({ result }) => {
  showEnd(result);
});

// state ã‚’éƒ¨å±‹ã«é€ã‚‹
function syncBroadcast(){
  if(!ROOM_ID) return;
  socket.emit('state', { roomId: ROOM_ID, state: serializeState() });
}

// ====== End Game Modal é–¢é€£ ======
function showEnd(resultText) {
  const colorMap = {
    A: "ğŸŸ¦",
    B: "ğŸŸ¨",
    C: "ğŸŸ©",
    D: "ğŸŸª",
    E: "ğŸŸ¥",
    F: "ğŸŸ«",
  };

  // "A 20 / B 18 / C 17" â†’ é…åˆ—ã«
  const parts = resultText.replace("çµ‚å±€: ", "").split("â†’ å‹è€…:");
  const stats = parts[0].split("/").map(s => s.trim()); // ["A 20", "B 18", "C 17"]
  const winner = parts[1].trim();                        // "A" ãªã©

  // è¡Œã‚’è‰²ã¨ã‚»ãƒƒãƒˆã§æ•´å½¢
  const lines = stats.map(line => {
    const [p, num] = line.split(" ");
    return `${colorMap[p] || ""} ${p}  ${num}æš`;
  });

  const winnerMark = winner.split(",").map(p => `${colorMap[p]} ${p}`).join(" & ");

  const formatted =
`ã‚²ãƒ¼ãƒ çµ‚äº†

${lines.join("\n")}

ğŸ† å‹è€…ï¼š${winnerMark}`;

  const modal = document.getElementById("endModal");
  const pre = document.getElementById("endResult");
  if (pre) pre.textContent = formatted;
  if (modal) modal.style.display = "flex";
}

function hideEnd() {
  const modal = document.getElementById("endModal");
  if (modal) modal.style.display = "none";
}

// ====== ã“ã“ã¾ã§ ======
</script>

<!-- ====== End Game Modal ====== -->
<div id="endModal" style="
  position:fixed; inset:0; background:rgba(0,0,0,.75);
  display:none; align-items:center; justify-content:center; z-index:100;">
  <div style="background:#111827; padding:24px; border-radius:14px; max-width:90%; text-align:center;">
    <h2 style="margin:0 0 12px; font-size:22px;">ã‚²ãƒ¼ãƒ çµ‚äº†</h2>
    <pre id="endResult" style="white-space:pre-wrap; margin-bottom:18px; font-size:16px;"></pre>
    <button id="closeEndBtn" onclick="hideEnd()" style="padding:10px 20px; border-radius:10px;">é–‰ã˜ã‚‹</button> 
  </div>
</div>

</body>
</html>
