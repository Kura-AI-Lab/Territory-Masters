<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Territory Masters â€” ç”Ÿå­˜ãƒ«ãƒ¼ãƒ« / 1ã€œ2ãƒã‚¹ç§»å‹• / é£›ã³è¶Šãˆä¸å¯ / çµ‚å±€ï¼æœ€å¾Œã®1äºº</title>

<!-- Socket.IOï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³åŒæœŸï¼‰ -->
<script src="/socket.io/socket.io.js"></script>

<style>
  :root{ --bg:#0f1226; --panel:#101839; --text:#e5e7eb; --muted:#94a3b8; --grid:#1e2447; --ok:#10b981; --warn:#ef4444;
         --pA:#60a5fa; --pB:#f59e0b; --pC:#34d399; --pD:#f472b6; --pE:#f87171; --pF:#a78bfa }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:
    radial-gradient(1200px 800px at 10% -10%, rgba(99,102,241,.25), transparent 60%),
    radial-gradient(1200px 800px at 110% 0%, rgba(56,189,248,.15), transparent 60%), var(--bg); color:var(--text);
    display:flex; flex-direction:column; gap:12px; padding:16px; padding-bottom:24px}
  header{display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap}
  h1{margin:0; font-size:20px}
  .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  button, select, input{background:linear-gradient(180deg,#243065,#1a224f); border:1px solid rgba(255,255,255,.08); color:var(--text); padding:10px 12px; border-radius:12px; font-weight:700}
  button{cursor:pointer}
  button:hover{filter:brightness(1.06)}
  main{display:grid; grid-template-columns: 1fr 380px; gap:12px}
  @media (max-width:980px){ main{grid-template-columns: 1fr} }
  .boardWrap{position:relative; background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px; display:flex; justify-content:center; align-items:center}
  svg{width:min(96vw,860px); height:auto; aspect-ratio:1/1; touch-action:manipulation}
  .hex{stroke:#17555d; stroke-width:1.2; fill:#2d5a8a; transition:filter .15s}
  .hex.dark{fill:#2b5387}
  .hex.hole{fill:#0b1030}
  .hex.legal{stroke-dasharray:4 3; stroke:#9ca3af}
  .hex.path{stroke:#6ee7b7}
  .disc{pointer-events:none}
  .A{fill:var(--pA)} .B{fill:var(--pB)} .C{fill:var(--pC)} .D{fill:var(--pD)} .E{fill:var(--pE)} .F{fill:var(--pF)}
  .sel{stroke:#fcd34d; stroke-width:3}
  .side{background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:10px}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .stat{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:8px 10px; font-weight:700}
  .muted{color:var(--muted)}
  .log{min-height:140px; max-height:40vh; overflow:auto; background:#0b1030; border:1px solid rgba(255,255,255,.1); border-radius:12px; padding:10px; font-family:ui-monospace, Menlo, Consolas, monospace; font-size:13px}
  .players{display:flex; gap:8px; flex-wrap:wrap}
  .chip{display:inline-flex; gap:6px; align-items:center; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:999px; padding:6px 10px; font-weight:700}
  .dot{width:12px; height:12px; border-radius:50%}
  @media (max-width:720px){ h1{font-size:18px} button, select{padding:12px 14px; border-radius:14px} .stat{padding:10px 12px} .log{max-height:30vh}}

  /* â–¼ è¿½åŠ ï¼šã‚¿ãƒ¼ãƒ³é–‹å§‹ãƒãƒŠãƒ¼ */
  .turn-banner{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    pointer-events:none; z-index:200;
    animation: fadeout 1.2s ease-out forwards;
  }
  .turn-banner .inner{
    background:rgba(0,0,0,.65); border:1px solid rgba(255,255,255,.15);
    padding:18px 24px; border-radius:16px; font-size:28px; font-weight:900;
    text-shadow:0 2px 12px rgba(0,0,0,.4);
  }
  @keyframes fadeout{
    0%{opacity:1; transform:scale(1)}
    70%{opacity:1}
    100%{opacity:0; transform:scale(0.98)}
  }
</style>
</head>
<body>
  <header>
    <h1>Territory Mastersï¼ˆ<span class="muted"> ç”Ÿå­˜ãƒ«ãƒ¼ãƒ« / 1ã€œ2ãƒã‚¹ç§»å‹• / é£›ã³è¶Šãˆä¸å¯</span>ï¼‰</h1>
    <div class="controls">
      <button id="newBtn" aria-label="ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ ">ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ </button>
      <button id="regenBtn" aria-label="åœ°å½¢å†ç”Ÿæˆ">åœ°å½¢å†ç”Ÿæˆ</button>
      <label class="stat">äººæ•°
        <select id="playersSel" aria-label="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°">
          <option value="2">2äºº</option>
          <option value="3" selected>3äºº</option>
          <option value="4">4äºº</option>
          <option value="5">5äºº</option>
        </select>
      </label>
      <label class="stat">ç›¤ã‚µã‚¤ã‚ºï¼ˆåŠå¾„ï¼‰
        <select id="radiusSel" aria-label="ç›¤ã®åŠå¾„">
          <option value="4">å° (R=4)</option>
          <option value="5" selected>ä¸­ (R=5)</option>
          <option value="6">å¤§ (R=6)</option>
        </select>
      </label>
      <label class="stat">ç©´% <span id="holePerc">10</span>
        <input id="holeRange" type="range" min="0" max="30" step="1" value="10" aria-label="ç©´ã®å‰²åˆ" />
      </label>
      <span class="stat">æ‰‹ç•ª: <span id="turn">A</span></span>
    </div>

    <!-- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å…¥å®¤UI -->
    <div class="controls">
      <input id="roomInput" placeholder="ãƒ«ãƒ¼ãƒ IDï¼ˆä¾‹: abc123ï¼‰" style="padding:10px;border-radius:10px;border:1px solid #fff2" />
      <button id="joinBtn" aria-label="å…¥å®¤">å…¥å®¤</button>
      <span id="roleView" class="muted"></span>
      <!-- â–¼ è¿½åŠ ï¼šäººæ•°è¡¨ç¤º -->
      <span id="roomCountView" class="muted"></span>
    </div>
  </header>

  <main>
    <div class="boardWrap">
      <svg id="svg" viewBox="0 0 1000 1000" role="img" aria-label="hex board"></svg>
    </div>

    <aside class="side">
      <div class="players" id="playersPanel"></div>
      <div class="row">
        <div class="stat" style="line-height:1.5">
          ãƒ«ãƒ¼ãƒ«è¦ç´„ï¼š<br>
          ãƒ»åˆæ‰‹ã¯ç›¤ä¸Šã®ã©ã“ã§ã‚‚OKï¼ˆç©´ãƒ»å æœ‰ä»¥å¤–ï¼‰<br>
          ãƒ»æ‰‹ç•ªã§ã¯è‡ªã‚³ãƒã‚’<b>1ãƒã‚¹ or 2ãƒã‚¹</b>ã®ç›´ç·šç§»å‹•ï¼ˆ2ãƒã‚¹æ™‚ã¯<b>ä¸­ç¶™ãƒã‚¹ã‚‚ç©ºãå¿…é ˆ</b>ï¼<b>æ•µã®é£›ã³è¶Šãˆä¸å¯</b>ï¼‰<br>
          ãƒ»ç§»å‹•å¾Œã€<b>ç§»å‹•å‰ã®ãƒã‚¹ã¯æ¶ˆãˆã‚‹ï¼ˆç©´åŒ–ï¼‰</b><br>
          ãƒ»<b>å‹•ã‘ãªããªã£ãŸã‚‰å³è„±è½</b>ï¼ˆä»¥å¾Œ æ‰‹ç•ªã¯å›ã£ã¦ã“ãªã„ï¼‰<br>
          ãƒ»<b>æœ€å¾Œã®1äººã«ãªã£ãŸæ™‚ç‚¹ã§ã‚²ãƒ¼ãƒ çµ‚äº†</b>ï¼ˆç”Ÿå­˜é †ï¼é †ä½ï¼‰
        </div>
      </div>
      <div class="row">
        <button id="undoBtn">ã‚¢ãƒ³ãƒ‰ã‚¥</button>
      </div>
      <div class="log" id="log"></div>
      <div class="muted">æ³¨: ãƒ©ãƒ³ãƒ€ãƒ å…­è§’ç›¤ï¼‹ãƒ©ãƒ³ãƒ€ãƒ ç©´ã§ç”Ÿæˆã—ã¾ã™ã€‚</div>
    </aside>
  </main>

<script>
// ========== ç”Ÿå­˜ãƒ«ãƒ¼ãƒ«ç‰ˆï¼ˆ1ã€œ2ãƒã‚¹ç§»å‹•ï¼é£›ã³è¶Šãˆä¸å¯ï¼è„±è½åˆ¶ï¼‰ ==========

// ---- è¦ç´ å‚ç…§ ----
const svg = document.getElementById('svg');
const logEl = document.getElementById('log');
const turnEl = document.getElementById('turn');
const holeRange = document.getElementById('holeRange');
const holePercEl = document.getElementById('holePerc');
const playersPanel = document.getElementById('playersPanel');
const playersSel = document.getElementById('playersSel');
const radiusSel = document.getElementById('radiusSel');
const boardWrap = document.querySelector('.boardWrap');

// ---- å®šæ•°ãƒ»çŠ¶æ…‹ ----
const DIRS = [ [1,0],[0,1],[-1,1],[-1,0],[0,-1],[1,-1] ]; // axial 6æ–¹å‘
let RADIUS = 5;
let HOLE_PERC = 10;
let PLAYER_COUNT = 3;
const PLAYERS = ['A','B','C','D','E','F'];
const COLORS = {A:'var(--pA)',B:'var(--pB)',C:'var(--pC)',D:'var(--pD)',E:'var(--pE)',F:'var(--pF)'};

const state = {
  cells: new Map(),  // id -> {q,r,id,hole:boolean,owner:null|'A'..}
  order: [],
  turnIdx: 0,
  phase: 'place',    // 'place' or 'play'
  selected: null,
  history: [],
  playersActive: [],
  elimOrder: [],
  // â–¼ å¤‰æ›´ï¼šæ–¹å‘åˆ¶é™ã¨ãƒ€ãƒƒã‚·ãƒ¥åˆ¶é™ã¯å»ƒæ­¢ã—ãŸã®ã§ä¿æŒã—ãªã„
  // lastDir: {},
  // sprintCD: {},
};

// ---- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ----
function k(q,r){ return q+","+r }
function addLog(s){ const ts=new Date().toLocaleTimeString([], {hour12:false}); logEl.textContent += `[${ts}] ${s}\n`; logEl.scrollTop=logEl.scrollHeight }
function fmt(c){ return `(${c.q},${c.r})` }

function genHexCoords(R){
  const coords=[];
  for(let q=-R;q<=R;q++){
    const r1 = Math.max(-R, -q-R);
    const r2 = Math.min(R, -q+R);
    for(let r=r1; r<=r2; r++) coords.push([q,r]);
  }
  return coords;
}
function axialToPixel(q,r){
  const sz = 30;
  const x = sz * (Math.sqrt(3) * (q + r/2)) + 500;
  const y = sz * (3/2 * r) + 500;
  return {x,y};
}
function hexPath(cx,cy,rad){
  const pts=[]; for(let i=0;i<6;i++){ const a=Math.PI/180*(60*i-30); const x=cx+rad*Math.cos(a), y=cy+rad*Math.sin(a); pts.push([x,y]); }
  return `M ${pts.map(p=>p.join(',')).join(' L ')} Z`;
}
function createSVG(tag, attrs){ const el=document.createElementNS('http://www.w3.org/2000/svg', tag); for(const kk in attrs) el.setAttribute(kk, attrs[kk]); return el }

// ---- ç›¤ç”Ÿæˆ ----
function buildBoard(){
  state.cells.clear(); state.order.length=0; svg.innerHTML='';
  const coords = genHexCoords(RADIUS);
  const holes = new Set();
  for(const [q,r] of coords){ if(Math.random()*100 < HOLE_PERC) holes.add(k(q,r)); }

  for(const [q,r] of coords){
    const id=k(q,r); const hole = holes.has(id);
    state.cells.set(id,{q,r,id,hole,owner:null}); state.order.push(id);
  }
  for(const id of state.order){
    const c=state.cells.get(id); const {x,y}=axialToPixel(c.q,c.r);
    const path = hexPath(x,y,26);
    const isDark = ((c.q+c.r)&1)===1;
    const el = createSVG('path',{d:path, class:`hex ${isDark?'dark':''} ${c.hole?'hole':''}`});
    el.dataset.id=id; if(!c.hole) el.addEventListener('click', ()=> onClickCell(id));
    svg.appendChild(el);
  }
}

// ---- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç† ----
function clampPlayers(n){ return Math.min(5, Math.max(2, n|0)); }
function setupPlayers(n){
  const clamped = clampPlayers(n);
  state.playersActive = PLAYERS.slice(0, clamped);
  state.elimOrder = [];
  state.turnIdx = 0; state.phase='place'; state.selected=null; state.history=[];
  renderPlayersPanel();
}
function renderPlayersPanel(){
  playersPanel.innerHTML='';
  for(const p of PLAYERS.slice(0,5)){
    const active = state.playersActive.includes(p);
    const chip = document.createElement('div'); chip.className='chip';
    chip.style.opacity = active ? 1 : 0.35;
    chip.innerHTML = `<span class="dot" style="background:${COLORS[p]}"></span>${p} ${active?'':'(è„±è½)'}`;
    playersPanel.appendChild(chip);
  }
}

// ---- æç”» ----
function render(){
  // ãƒªã‚»ãƒƒãƒˆ
  const nodes = [...svg.querySelectorAll('.hex')].filter(n=>n.dataset.id);
  nodes.forEach(n=>{ n.classList.remove('legal','path','sel'); });
  svg.querySelectorAll('.disc').forEach(n=> n.remove());

  // é§’æç”»ï¼ˆå„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1é§’ï¼‰
  for(const id of state.order){
    const c=state.cells.get(id); if(c.hole) continue; const {x,y}=axialToPixel(c.q,c.r);
    if(c.owner){
      const circ = createSVG('circle',{cx:x, cy:y, r:20, class:`disc ${c.owner}`}); svg.appendChild(circ);
    }
  }

  // çŠ¶æ…‹ã¨DOMã®ç©´ã‚¯ãƒ©ã‚¹åŒæœŸ
  for (const id of state.order) {
    const c = state.cells.get(id);
    const n = svg.querySelector(`.hex[data-id="${id}"]`);
    if (!n) continue;
    if (c.hole) n.classList.add('hole');
    else n.classList.remove('hole');
  }

  // ã‚¿ãƒ¼ãƒ³è¡¨ç¤º
  const turnP = state.playersActive[state.turnIdx] || '-';
  turnEl.textContent = turnP;
  renderPlayersPanel();

  // ã‚¢ãƒ•ã‚©ãƒ¼ãƒ€ãƒ³ã‚¹
  for(const id of legalCells()){ const n = svg.querySelector(`.hex[data-id="${id}"]`); if(n) n.classList.add('legal'); }
  if(state.selected){
    const n = svg.querySelector(`.hex[data-id="${state.selected}"]`);
    if(n) n.classList.add('sel');
    for(const cid of reachableCellsFrom(state.selected)){
      const nn = svg.querySelector(`.hex[data-id="${cid}"]`);
      if(nn) nn.classList.add('path');
    }
  }
}

// ---- æ‰‹ç•ªå¯èƒ½ã‚»ãƒ« / åˆ°é”ã‚»ãƒ« ----
function legalCells(){
  const turnP = state.playersActive[state.turnIdx];
  if(!turnP) return [];
  if(state.phase==='place'){
    return state.order.filter(id=>{ const c=state.cells.get(id); return !c.hole && !c.owner; });
  }else{
    const myCell = state.order.find(id=>{ const c=state.cells.get(id); return c.owner===turnP; });
    if(!myCell) return [];
    return reachableCellsFrom(myCell).length>0 ? [myCell] : [];
  }
}

// â–¼ å¤‰æ›´ï¼šæ–¹å‘é€£ç¶šç¦æ­¢ã¨ã€Œ2æ­©å¾Œã®1æ­©ç¸›ã‚Šã€ã‚’å®Œå…¨æ’¤å»ƒ
function reachableCellsFrom(id){
  const src = state.cells.get(id); if(!src) return [];
  const res = [];
  for(let dirIdx=0; dirIdx<DIRS.length; dirIdx++){
    const d = DIRS[dirIdx];
    const step1 = state.cells.get(k(src.q + d[0], src.r + d[1]));
    if(step1 && !step1.hole && !step1.owner){
      res.push(step1.id); // 1æ­©
      const step2 = state.cells.get(k(step1.q + d[0], step1.r + d[1]));
      if(step2 && !step2.hole && !step2.owner){
        res.push(step2.id); // 2æ­©ï¼ˆä¸­ç¶™ç©ºãå¿…é ˆï¼‰
      }
    }
  }
  return res;
}

function playerHasMove(p){
  const pos = state.order.find(id=>{ const c=state.cells.get(id); return c.owner===p; });
  if(!pos) return false;
  return reachableCellsFrom(pos).length>0;
}

// ---- ã‚¿ãƒ¼ãƒ³é€²è¡Œãƒ»è„±è½åˆ¤å®š ----
function advanceTurnSkippingDead(){
  // æ¬¡ã®ç”Ÿå­˜è€…ã§ã€ã‹ã¤å‹•ã‘ã‚‹äººã«å›ã™
  let safety = 20;
  while(safety--){
    if(state.playersActive.length<=1){ endGame(); return; }
    state.turnIdx = (state.turnIdx + 1) % state.playersActive.length;
    const p = state.playersActive[state.turnIdx];
    if(playerHasMove(p)) break;
    eliminatePlayer(p, 'è¡Œå‹•ä¸èƒ½');
    if(state.playersActive.length<=1){ endGame(); return; }
  }
  render();
  showTurnBanner(state.playersActive[state.turnIdx]); // â–¼ è¿½åŠ ï¼šãƒãƒŠãƒ¼è¡¨ç¤º
  syncBroadcast();
}

function eliminatePlayer(p, reason='è„±è½'){
  // é§’ã‚»ãƒ«ã‚‚ç©´åŒ–
  const pos = state.order.find(id=>{ const c=state.cells.get(id); return c.owner===p; });
  if(pos){
    const c = state.cells.get(pos);
    c.owner = null; c.hole = true;
    const node = svg.querySelector(`.hex[data-id="${pos}"]`);
    if(node) node.classList.add('hole');
  }
  // è„±è½ãƒªã‚¹ãƒˆ
  const idx = state.playersActive.indexOf(p);
  if(idx!==-1){
    state.playersActive.splice(idx,1);
    state.elimOrder.push(p);
    if(state.turnIdx>=state.playersActive.length){ state.turnIdx = 0; }
    addLog(`${p} è„±è½ï¼ˆ${reason}ï¼‰`);
  }
}

function endGame(){
  if(state.playersActive.length===1){
    const winner = state.playersActive[0];
    const ranking = [winner, ...state.elimOrder.slice().reverse()];
    const text = `çµ‚å±€: ğŸ† å‹è€… ${winner} / ç”Ÿå­˜é †: ${ranking.join(' > ')}`;
    addLog(text);

    // â˜… æ˜ç¤ºæƒ…å ±ã¤ãã§è‡ªåˆ†ã‚‚è¡¨ç¤º
    showEnd(text, { winner, survivors:[...state.playersActive], elim:[...state.elimOrder] });

    // â˜… ã‚µãƒ¼ãƒã¸ã‚‚åŒã˜æƒ…å ±ã‚’é€ã‚‹
    if (ROOM_ID) socket.emit('end', {
      roomId: ROOM_ID,
      result: text,
      winner,
      survivors: [...state.playersActive],
      elim: [...state.elimOrder],
    });
  }else{
    const text = `çµ‚å±€: å…¨å“¡è„±è½`;
    addLog(text);
    showEnd(text, { winner:null, survivors:[], elim:[...state.elimOrder] });
    if (ROOM_ID) socket.emit('end', {
      roomId: ROOM_ID,
      result: text,
      winner: null,
      survivors: [],
      elim: [...state.elimOrder],
    });
  }
}

// ---- ãƒ’ã‚¹ãƒˆãƒªï¼ˆã‚¢ãƒ³ãƒ‰ã‚¥ç”¨ï¼‰ ----
function pushHistory(){
  const snapshot = {
    turnIdx: state.turnIdx, phase: state.phase, selected: state.selected,
    playersActive: [...state.playersActive], elimOrder: [...state.elimOrder],
    cells: [...state.order].map(id=>{ const c=state.cells.get(id); return {id, owner:c.owner, hole:c.hole}; }),
  };
  state.history.push(snapshot); if(state.history.length>200) state.history.shift();
}
function undo(){
  const s = state.history.pop(); if(!s) return;
  state.turnIdx=s.turnIdx; state.phase=s.phase; state.selected=s.selected;
  state.playersActive=[...s.playersActive]; state.elimOrder=[...s.elimOrder];
  for(const info of s.cells){ const c=state.cells.get(info.id); if(!c) continue; c.owner=info.owner; c.hole=info.hole; }
  addLog('ã‚¢ãƒ³ãƒ‰ã‚¥');
  redrawBoardFromState();
  render();
  syncBroadcast();
}

// ---- ã‚¯ãƒªãƒƒã‚¯å‡¦ç† ----
function onClickCell(id){
  const turnP = state.playersActive[state.turnIdx];
  const cell = state.cells.get(id);
  if(cell.hole) return;

  if(state.phase==='place'){
    if(cell.owner){ return; }
    pushHistory();
    cell.owner = turnP;
    addLog(`${turnP} åˆæœŸé…ç½® @ ${fmt(cell)}`);
    if(state.turnIdx < state.playersActive.length-1){ state.turnIdx++; }
    else {
      state.turnIdx=0; state.phase='play';
      addLog('ãƒ—ãƒ¬ã‚¤é–‹å§‹ï¼š1ã€œ2ãƒã‚¹ç›´ç·šç§»å‹•ï¼ç§»å‹•å…ƒã¯ç©´åŒ–ï¼è¡Œå‹•ä¸èƒ½ã¯å³è„±è½');
      showTurnBanner(state.playersActive[state.turnIdx]); // â–¼ è¿½åŠ ï¼šé–‹å§‹æ™‚ã«ãƒãƒŠãƒ¼
    }
    render();
    syncBroadcast();
    return;
  }

  // ãƒ—ãƒ¬ã‚¤ä¸­
  if(state.selected===id){
    state.selected=null; render(); return;
  }

  // è‡ªé§’é¸æŠ
  const myCellId = state.order.find(cid=>{ const c=state.cells.get(cid); return c.owner===turnP; });
  if(!myCellId) return;

  if(id===myCellId){
    state.selected = id; render(); return;
  }

  // ç›®çš„åœ°ã¸
  if(state.selected){
    const reach = new Set(reachableCellsFrom(state.selected));
    if(reach.has(id)){
      pushHistory();
      const src = state.cells.get(state.selected);
      const dst = state.cells.get(id);

      // å…ƒãƒã‚¹ã‚’ç©´åŒ– â†’ ç›®çš„åœ°ã¸ç§»å‹•
      src.owner = null;
      src.hole = true;
      const node = svg.querySelector(`.hex[data-id="${src.id}"]`);
      if (node) node.classList.add('hole');
      dst.owner = turnP;

      addLog(`${turnP} ç§»å‹• ${fmt(src)} â†’ ${fmt(dst)}`);

      state.selected=null;
      advanceTurnSkippingDead();
      return;
    }
  }
}

// ---- å„ç¨®ã‚¤ãƒ™ãƒ³ãƒˆ ----
document.getElementById('newBtn').addEventListener('click', ()=>{
  buildBoard();
  setupPlayers(PLAYER_COUNT);
  addLog(`--- New Game --- åˆæœŸé…ç½®ã¸`);
  render();
  showTurnBanner(state.playersActive[state.turnIdx]); // â–¼ è¿½åŠ 
  syncBroadcast();
});
document.getElementById('regenBtn').addEventListener('click', ()=>{
  buildBoard();
  setupPlayers(PLAYER_COUNT);
  addLog(`--- åœ°å½¢ã‚’å†ç”Ÿæˆã—ã¾ã—ãŸ --- åˆæœŸé…ç½®ã¸`);
  render();
  showTurnBanner(state.playersActive[state.turnIdx]); // â–¼ è¿½åŠ 
  syncBroadcast();
});
playersSel.addEventListener('change', (e)=>{
  PLAYER_COUNT = clampPlayers(parseInt(e.target.value,10));
  setupPlayers(PLAYER_COUNT);
  render();
  syncBroadcast();
});
radiusSel.addEventListener('change', (e)=>{
  RADIUS = parseInt(e.target.value,10);
  buildBoard(); setupPlayers(PLAYER_COUNT);
  render();
  showTurnBanner(state.playersActive[state.turnIdx]); // â–¼ è¿½åŠ 
  syncBroadcast();
});
document.getElementById('undoBtn').addEventListener('click', undo);
holeRange.addEventListener('input', ()=>{
  HOLE_PERC=parseInt(holeRange.value,10); holePercEl.textContent=HOLE_PERC;
});

// åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
buildBoard(); setupPlayers(PLAYER_COUNT); render(); addLog('åˆæœŸé…ç½®ï¼šç©´ãƒ»å æœ‰ä»¥å¤–ãªã‚‰ã©ã“ã§ã‚‚OK');
showTurnBanner('A'); // â–¼ è¿½åŠ ï¼šåˆæœŸè¡¨ç¤º

// ==================== ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åŒæœŸï¼ˆSocket.IOï¼‰ ====================
const socket = io();
let ROOM_ID = null;

const roomInput = document.getElementById('roomInput');
const joinBtn = document.getElementById('joinBtn');
const roleView = document.getElementById('roleView');
const roomCountView = document.getElementById('roomCountView');

// â–¼ è¿½åŠ ï¼šå…¥å®¤äººæ•°ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¡¨ç¤ºç”¨ï¼‰
let ROOM_SIZE = 1;
function updateRoomCountView(){
  if(ROOM_ID){
    roomCountView.textContent = `äººæ•°: ${ROOM_SIZE}`;
  }else{
    roomCountView.textContent = '';
  }
}
// â–¼ è¿½åŠ ï¼šå…¥å®¤äººæ•°ã«åˆã‚ã›ã¦è‡ªå‹•ã§ã‚²ãƒ¼ãƒ äººæ•°ã‚’åˆ‡æ›¿ï¼ˆ2ã€œ5ã®ã¿ï¼‰
function applyAutoPlayerCountByRoom(){
  if(ROOM_SIZE>=2 && ROOM_SIZE<=5){
    if(PLAYER_COUNT !== ROOM_SIZE){
      PLAYER_COUNT = ROOM_SIZE;
      playersSel.value = String(PLAYER_COUNT);
      buildBoard(); setupPlayers(PLAYER_COUNT); render();
      addLog(`å…¥å®¤äººæ•°ã«åˆã‚ã›ã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°ã‚’ ${PLAYER_COUNT} äººã«å¤‰æ›´ã—ã¾ã—ãŸ`);
      showTurnBanner(state.playersActive[state.turnIdx]);
      syncBroadcast();
    }
  }
}

if (joinBtn) {
  joinBtn.addEventListener('click', ()=>{
    const id = (roomInput.value||'').trim();
    if(!id){ alert('ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›'); return; }
    ROOM_ID = id;
    socket.emit('join', { roomId: ROOM_ID });
    roleView.textContent = `å…¥å®¤ä¸­: ${ROOM_ID}`;
    updateRoomCountView();
    // ã‚µãƒ¼ãƒã«äººæ•°ç…§ä¼šï¼ˆå¯¾å¿œã‚µãƒ¼ãƒæƒ³å®šï¼‰ã€‚æœªå¯¾å¿œã§ã‚‚å•é¡Œãªã—ã€‚
    socket.emit('roomSize', { roomId: ROOM_ID, ask:true });
    syncBroadcast(); // ç¾çŠ¶ã‚’é€ã‚‹
  });
}

// é€å—ä¿¡ã™ã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆ
function serializeState(){
  return {
    turnIdx: state.turnIdx,
    phase: state.phase,
    playersActive: [...state.playersActive],
    elimOrder: [...state.elimOrder],
    order: [...state.order],
    cells: state.order.map(id=>{
      const c = state.cells.get(id);
      return { id, q:c.q, r:c.r, hole:c.hole, owner:c.owner };
    })
  };
}

function adoptServerState(s){
  state.turnIdx = s.turnIdx;
  state.phase = s.phase;
  state.playersActive = [...s.playersActive];
  state.elimOrder = [...s.elimOrder];
  state.order = [...s.order];
  state.selected = null;

  state.cells.clear();
  for(const c of s.cells){
    state.cells.set(c.id, { q:c.q, r:c.r, id:c.id, hole:c.hole, owner:c.owner });
  }
  redrawBoardFromState();
  render();
}
function redrawBoardFromState(){
  svg.innerHTML = '';
  for(const id of state.order){
    const c = state.cells.get(id);
    const {x,y} = axialToPixel(c.q, c.r);
    const path = hexPath(x,y,26);
    const isDark = ((c.q+c.r)&1)===1;
    const el = createSVG('path', { d:path, class:`hex ${isDark?'dark':''} ${c.hole?'hole':''}` });
    el.dataset.id = id;
    if(!c.hole) el.addEventListener('click', ()=> onClickCell(id));
    svg.appendChild(el);
  }
}

socket.on('state', ({ state:serverState })=>{ adoptServerState(serverState); });
socket.on('end', ({ result, winner, survivors, elim }) => {
  showEnd(result, { winner, survivors, elim });
});
// â–¼ è¿½åŠ ï¼šã‚µãƒ¼ãƒã‹ã‚‰äººæ•°æƒ…å ±ã‚’å—ä¿¡ï¼ˆ{ roomId, count }ï¼‰
socket.on('roomSize', ({ roomId, count })=>{
  if(ROOM_ID && roomId===ROOM_ID){
    ROOM_SIZE = Math.max(1, count|0);
    updateRoomCountView();
    applyAutoPlayerCountByRoom();
  }
});

function syncBroadcast(){
  if(!ROOM_ID) return;
  socket.emit('state', { roomId: ROOM_ID, state: serializeState() });
}

// ========== End Game Modal ==========
function showEnd(resultText, extra = {}) {
  const colorMap = {A:"ğŸŸ¦",B:"ğŸŸ¨",C:"ğŸŸ©",D:"ğŸŸª",E:"ğŸŸ¥",F:"ğŸŸ«"};
  const { winner = null, survivors = null, elim = null } = extra;

  const modal = document.getElementById("endModal");
  const pre = document.getElementById("endResult");
  if (pre) {
    const survivorsText = Array.isArray(survivors) ? survivors.join(" ") :
                          (state.playersActive.join(" ") || "ãªã—");
    const elimText = Array.isArray(elim) ? elim.join(" â†’ ") :
                     (state.elimOrder.join(" â†’ ") || "ãªã—");

    let hero = "â€”";
    if (winner) {
      const icon = colorMap[winner] || "";
      hero = `${icon} ${winner}`;
    } else if (state.playersActive.length === 1) {
      const w = state.playersActive[0];
      const icon = colorMap[w] || "";
      hero = `${icon} ${w}`;
    }

    pre.textContent = `${resultText}\n\nã€ã‚µãƒãƒªã€‘\nç”Ÿå­˜: ${survivorsText}\nè„±è½é †: ${elimText}\nå‹è€…: ${hero}`;
  }
  if (modal) modal.style.display = "flex";
}

function hideEnd() {
  const modal = document.getElementById("endModal");
  if (modal) modal.style.display = "none";
}

// â–¼ è¿½åŠ ï¼šã‚¿ãƒ¼ãƒ³é–‹å§‹ã®å¤§ããªãƒãƒŠãƒ¼
function showTurnBanner(p){
  if(!p) return;
  const wrap = document.createElement('div');
  wrap.className = 'turn-banner';
  const inner = document.createElement('div');
  inner.className = 'inner';
  const color = COLORS[p] || '#fff';
  inner.style.borderColor = 'rgba(255,255,255,.2)';
  inner.innerHTML = `<span style="display:inline-flex;gap:10px;align-items:center">
    <span class="dot" style="background:${color};width:18px;height:18px"></span>
    <span>ï¼ˆ${p} ã®ç•ªã§ã™ï¼‰</span>
  </span>`;
  wrap.appendChild(inner);
  document.body.appendChild(wrap);
  setTimeout(()=>{ wrap.remove(); }, 1200); // ã™ãæ¶ˆãˆã‚‹
}
</script>

<!-- End Game Modal -->
<div id="endModal" style="position:fixed; inset:0; background:rgba(0,0,0,.75); display:none; align-items:center; justify-content:center; z-index:100;">
  <div style="background:#111827; padding:24px; border-radius:14px; max-width:90%; text-align:center;">
    <h2 style="margin:0 0 12px; font-size:22px;">ã‚²ãƒ¼ãƒ çµ‚äº†</h2>
    <pre id="endResult" style="white-space:pre-wrap; margin-bottom:18px; font-size:16px;"></pre>
    <button id="closeEndBtn" onclick="hideEnd()" style="padding:10px 20px; border-radius:10px;">é–‰ã˜ã‚‹</button> 
  </div>
</div>

</body>
</html>
